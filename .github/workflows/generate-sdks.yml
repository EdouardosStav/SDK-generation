name: 🚀 Enterprise SDK Generation Pipeline

on:
  push:
    branches: [ main ]
    paths: [ 'specs/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'specs/**' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      force_regenerate:
        description: 'Force regeneration of all SDKs'
        required: false
        default: false
        type: boolean

env:
  TECHCORP_VERSION: "1.0.0"
  COMPANY_NAME: "TechCorp"

jobs:
  validate-spec:
    name: 🔍 Validate OpenAPI Specification
    runs-on: ubuntu-latest
    outputs:
      spec-valid: ${{ steps.validate.outputs.valid }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Install OpenAPI Generator
      run: npm install -g @openapitools/openapi-generator-cli

    - name: Validate OpenAPI Spec
      id: validate
      run: |
        echo "🔍 Validating OpenAPI specification..."
        if openapi-generator-cli validate -i specs/api-spec.yaml; then
          echo "✅ OpenAPI spec is valid!"
          echo "valid=true" >> $GITHUB_OUTPUT
        else
          echo "❌ OpenAPI spec validation failed!"
          echo "valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi

  generate-enterprise-sdks:
    name: 🏭 Generate Enterprise SDKs
    runs-on: ubuntu-latest
    needs: validate-spec
    if: needs.validate-spec.outputs.spec-valid == 'true'
    
    strategy:
      matrix:
        language: [python, javascript, go, java, csharp, php]
      fail-fast: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0'

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer

    - name: Install OpenAPI Generator
      run: npm install -g @openapitools/openapi-generator-cli

    - name: Generate ${{ matrix.language }} SDK only
      run: |
        echo "🚀 Generating ${{ matrix.language }} SDK..."
        
        # Create output directory
        mkdir -p generated-sdks/${{ matrix.language }}
        
        # Generate the specific SDK
        case "${{ matrix.language }}" in
          python)
            openapi-generator-cli generate -i specs/api-spec.yaml -g python -o generated-sdks/python --additional-properties=packageName=techcorp_api_client,projectName=techcorp-api-client,packageVersion=1.0.0
            ;;
          javascript)
            openapi-generator-cli generate -i specs/api-spec.yaml -g javascript -o generated-sdks/javascript --additional-properties=projectName=techcorp-api-client,projectVersion=1.0.0
            ;;
          go)
            openapi-generator-cli generate -i specs/api-spec.yaml -g go -o generated-sdks/go --additional-properties=packageName=techcorpapi,packageVersion=1.0.0
            ;;
          java)
            openapi-generator-cli generate -i specs/api-spec.yaml -g java -o generated-sdks/java --additional-properties=groupId=com.techcorp,artifactId=api-client,artifactVersion=1.0.0
            ;;
          csharp)
            openapi-generator-cli generate -i specs/api-spec.yaml -g csharp -o generated-sdks/csharp --additional-properties=packageName=TechCorp.ApiClient,packageVersion=1.0.0
            ;;
          php)
            openapi-generator-cli generate -i specs/api-spec.yaml -g php -o generated-sdks/php --additional-properties=packageName=TechCorpApiClient,artifactVersion=1.0.0
            ;;
        esac
        
        echo "✅ ${{ matrix.language }} SDK generated successfully!"

    - name: Upload ${{ matrix.language }} SDK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: sdk-${{ matrix.language }}
        path: generated-sdks/${{ matrix.language }}/
        retention-days: 30

  create-pull-request:
    name: 📋 Create SDK Update PR
    runs-on: ubuntu-latest
    needs: [validate-spec, generate-enterprise-sdks]
    if: always() && needs.validate-spec.outputs.spec-valid == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all SDK artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Organize SDK files
      run: |
        echo "📁 Organizing SDK files..."
        mkdir -p generated-sdks
        
        # Move each SDK to the correct location
        for sdk_dir in artifacts/sdk-*/; do
          if [ -d "$sdk_dir" ]; then
            sdk_name=$(basename "$sdk_dir" | sed 's/sdk-//')
            echo "Moving $sdk_name SDK..."
            mv "$sdk_dir" "generated-sdks/$sdk_name"
          fi
        done
        
        # List what we have
        echo "📊 Generated SDKs:"
        ls -la generated-sdks/

    - name: Generate PR metrics
      id: metrics
      run: |
        echo "📊 Calculating SDK metrics..."
        
        total_files=0
        sdk_count=0
        
        for sdk_dir in generated-sdks/*/; do
          if [ -d "$sdk_dir" ]; then
            sdk_count=$((sdk_count + 1))
            files=$(find "$sdk_dir" -type f | wc -l)
            total_files=$((total_files + files))
            echo "📁 $(basename "$sdk_dir"): $files files"
          fi
        done
        
        echo "sdk-count=$sdk_count" >> $GITHUB_OUTPUT
        echo "total-files=$total_files" >> $GITHUB_OUTPUT

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: '🚀 Enterprise SDK Generation: Auto-update all SDKs'
        title: '🎉 Enterprise SDK Updates - v${{ env.TECHCORP_VERSION }}'
        body: |
          # 🏭 Enterprise SDK Generation Complete!
          
          This PR contains automatically generated enterprise-grade SDKs for the TechCorp API.
          
          ## 📊 Generation Summary
          - **🎯 SDKs Generated**: ${{ steps.metrics.outputs.sdk-count }} languages
          - **📁 Total Files**: ${{ steps.metrics.outputs.total-files }}
          - **⚡ Pipeline Run**: #${{ github.run_number }}
          - **🔄 Commit**: `${{ github.sha }}`
          
          ## 🚀 Available SDKs
          
          | Language | Status | Ready for |
          |----------|--------|-----------|
          | 🐍 **Python** | ✅ Generated | PyPI |
          | 📜 **JavaScript** | ✅ Generated | npm |
          | 🐹 **Go** | ✅ Generated | Go Modules |
          | ☕ **Java** | ✅ Generated | Maven Central |
          | 🔷 **C#** | ✅ Generated | NuGet |
          | 🐘 **PHP** | ✅ Generated | Packagist |
          
          ## ✅ Quality Checks
          - [x] OpenAPI specification validated
          - [x] All SDKs generated successfully  
          - [x] Artifacts uploaded
          
          ---
          🤖 *Auto-generated by TechCorp Enterprise SDK Pipeline*
        branch: enterprise-sdk-updates
        delete-branch: true
        draft: false

  notify-completion:
    name: 🔔 Notify Completion
    runs-on: ubuntu-latest
    needs: [validate-spec, generate-enterprise-sdks, create-pull-request]
    if: always()
    
    steps:
    - name: Generate completion summary
      run: |
        echo "🎊 TechCorp Enterprise SDK Pipeline Complete! 🎊"
        echo "📊 Pipeline Run: #${{ github.run_number }}"
        echo "⏰ Completed: $(date)"
        echo "🔗 View Results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"